<mat-sidenav-container class="dashboard-container">
  <!-- Sidebar Navigation -->
  <mat-sidenav #sidenav 
               [opened]="isSidenavOpen" 
               mode="side" 
               class="dashboard-sidenav">
    <app-sidebar [currentUser]="currentUser"></app-sidebar>
  </mat-sidenav>

  <!-- Main Content -->
  <mat-sidenav-content class="dashboard-content">
    <!-- Top Toolbar -->
    <mat-toolbar class="dashboard-toolbar">
      <button mat-icon-button (click)="toggleSidenav()">
        <mat-icon>menu</mat-icon>
      </button>
      
      <span class="toolbar-title">Dashboard</span>
      
      <span class="toolbar-spacer"></span>
      
      <div class="toolbar-actions">
        <span class="welcome-text">Welcome, {{ currentUser?.firstName }}!</span>
      </div>
    </mat-toolbar>

    <!-- Dashboard Content -->
    <div class="main-content">
      
      <!-- ADMIN DASHBOARD with Filters and Analytics -->
      @if (isAdmin()) {
        <!-- Filters Section -->
        <div class="filters-section">
          <div class="filters-header">
            <div>
              <h2>Analytics Dashboard</h2>
              <p>Comprehensive view of system performance and metrics</p>
            </div>
            <div class="filter-actions">
              <button mat-raised-button color="primary" (click)="applyFilters()">
                <mat-icon>filter_list</mat-icon>
                Apply Filters
              </button>
              <button mat-stroked-button (click)="clearFilters()">
                <mat-icon>clear</mat-icon>
                Clear
              </button>
            </div>
          </div>
          
          <div class="filters-grid">
            <!-- System Admin: Municipality Filter -->
            @if (isSystemAdmin()) {
            <mat-form-field appearance="outline">
              <mat-label>Municipality</mat-label>
              <mat-select [(ngModel)]="selectedMunicipalityId">
                <mat-option value="all">All Municipalities</mat-option>
                @for (municipality of municipalities; track municipality.id) {
                <mat-option [value]="municipality.id">
                  {{ municipality.name }}
                </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>location_city</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Region</mat-label>
              <mat-select [(ngModel)]="selectedRegion">
                @for (region of regions; track region) {
                <mat-option [value]="region">
                  {{ region === 'all' ? 'All Regions' : region }}
                </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>map</mat-icon>
            </mat-form-field>
            }

            <!-- Municipality Admin: Collection Point Filter -->
            @if (isMunicipalityAdmin()) {
            <mat-form-field appearance="outline">
              <mat-label>Collection Point / Sede</mat-label>
              <mat-select [(ngModel)]="selectedCollectionPointId">
                <mat-option value="all">All Collection Points</mat-option>
                @for (cp of collectionPoints; track cp.id) {
                <mat-option [value]="cp.id">
                  {{ cp.name }}
                </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>place</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Zone</mat-label>
              <mat-select [(ngModel)]="selectedRegion">
                @for (zone of zones; track zone) {
                <mat-option [value]="zone">
                  {{ zone === 'all' ? 'All Zones' : 'Zone ' + zone }}
                </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>map</mat-icon>
            </mat-form-field>
            }

            <mat-form-field appearance="outline">
              <mat-label>Material Type</mat-label>
              <mat-select [(ngModel)]="selectedMaterialType">
                @for (material of materialTypes; track material) {
                <mat-option [value]="material">
                  {{ getMaterialTypeLabel(material) }}
                </mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>recycling</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date Range</mat-label>
              <mat-date-range-input [rangePicker]="picker">
                <input matStartDate [(ngModel)]="startDate" placeholder="Start date">
                <input matEndDate [(ngModel)]="endDate" placeholder="End date">
              </mat-date-range-input>
              <mat-datepicker-toggle matIconPrefix [for]="picker"></mat-datepicker-toggle>
              <mat-date-range-picker #picker></mat-date-range-picker>
              <mat-icon matPrefix>calendar_today</mat-icon>
            </mat-form-field>
          </div>
        </div>

        <!-- Loading Spinner -->
        @if (isLoading) {
          <div class="loading-container">
            <mat-spinner></mat-spinner>
            <p>Loading dashboard data...</p>
          </div>
        }

        <!-- Aggregated Stats Cards -->
        @if (!isLoading) {
          <div class="stats-grid">
            <!-- System Admin: Total Municipalities / Municipality Admin: Collection Points -->
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon primary">
                  <mat-icon>{{ isSystemAdmin() ? 'location_city' : 'place' }}</mat-icon>
                </div>
                <div class="stat-change positive">Active</div>
              </div>
              <h3 class="stat-value">{{ isSystemAdmin() ? aggregatedStats.totalMunicipalities : collectionPoints.length }}</h3>
              <p class="stat-label">{{ isSystemAdmin() ? 'Total Municipalities' : 'Collection Points' }}</p>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon accent">
                  <mat-icon>people</mat-icon>
                </div>
                <div class="stat-change positive">+5%</div>
              </div>
              <h3 class="stat-value">{{ aggregatedStats.totalCitizens | number }}</h3>
              <p class="stat-label">Total Citizens</p>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon primary">
                  <mat-icon>recycling</mat-icon>
                </div>
                <div class="stat-change positive">+12%</div>
              </div>
              <h3 class="stat-value">{{ aggregatedStats.totalCollections | number }}</h3>
              <p class="stat-label">Total Collections</p>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon accent">
                  <mat-icon>scale</mat-icon>
                </div>
                <div class="stat-change positive">+8%</div>
              </div>
              <h3 class="stat-value">{{ aggregatedStats.totalWasteCollected | number }}</h3>
              <p class="stat-label">Waste Collected (kg)</p>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon primary">
                  <mat-icon>stars</mat-icon>
                </div>
                <div class="stat-change positive">+10%</div>
              </div>
              <h3 class="stat-value">{{ aggregatedStats.totalPointsDistributed | number }}</h3>
              <p class="stat-label">Points Distributed</p>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon accent">
                  <mat-icon>warning</mat-icon>
                </div>
                <div class="stat-change" [class.positive]="aggregatedStats.activeAlerts === 0" [class.negative]="aggregatedStats.activeAlerts > 0">
                  {{ aggregatedStats.activeAlerts === 0 ? 'None' : aggregatedStats.activeAlerts }}
                </div>
              </div>
              <h3 class="stat-value">{{ aggregatedStats.activeAlerts }}</h3>
              <p class="stat-label">Active Alerts</p>
            </div>
          </div>
        }
      }

      <!-- CITIZEN DASHBOARD (Original) -->
      @if (isCitizen()) {
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon primary">
              <mat-icon>stars</mat-icon>
            </div>
            <div class="stat-change positive">+12%</div>
          </div>
          <h3 class="stat-value">{{ citizenStats.totalPoints }}</h3>
          <p class="stat-label">Total Points</p>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon accent">
              <mat-icon>recycling</mat-icon>
            </div>
            <div class="stat-change positive">+8%</div>
          </div>
          <h3 class="stat-value">{{ citizenStats.wasteCollected }}</h3>
          <p class="stat-label">Waste Collected (kg)</p>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon primary">
              <mat-icon>card_giftcard</mat-icon>
            </div>
            <div class="stat-change positive">+5%</div>
          </div>
          <h3 class="stat-value">{{ citizenStats.rewardsEarned }}</h3>
          <p class="stat-label">Rewards Earned</p>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon accent">
              <mat-icon>eco</mat-icon>
            </div>
            <div class="stat-change positive">+15%</div>
          </div>
          <h3 class="stat-value">{{ citizenStats.environmentalImpact }}</h3>
          <p class="stat-label">COâ‚‚ Saved (kg)</p>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="recent-activity">
        <h3>Recent Activity</h3>
        
        <div class="activity-item">
          <div class="activity-icon">
            <mat-icon>recycling</mat-icon>
          </div>
          <div class="activity-content">
            <h4 class="activity-title">Metal waste collected</h4>
            <p class="activity-time">2 hours ago</p>
          </div>
        </div>
        
        <div class="activity-item">
          <div class="activity-icon">
            <mat-icon>card_giftcard</mat-icon>
          </div>
          <div class="activity-content">
            <h4 class="activity-title">Reward redeemed</h4>
            <p class="activity-time">1 day ago</p>
          </div>
        </div>
        
        <div class="activity-item">
          <div class="activity-icon">
            <mat-icon>eco</mat-icon>
          </div>
          <div class="activity-content">
            <h4 class="activity-title">Environmental impact achieved</h4>
            <p class="activity-time">3 days ago</p>
          </div>
        </div>
      </div>
      }

      <!-- Analytics Visualizations for Admins -->
      @if (isAdmin() && !isLoading) {
        <mat-tab-group class="analytics-tabs">
          <!-- Top Municipalities (System Admin) / Top Collection Points (Municipality Admin) -->
          <mat-tab [label]="isSystemAdmin() ? 'Top Municipalities' : 'Top Collection Points'">
            <div class="tab-content">
              <!-- System Admin: Top Municipalities -->
              @if (isSystemAdmin()) {
              <div class="ranking-list">
                @for (municipality of topMunicipalities; track municipality.name; let i = $index) {
                <div class="ranking-item">
                  <div class="rank-badge" [class.gold]="i === 0" [class.silver]="i === 1" [class.bronze]="i === 2">
                    {{ i + 1 }}
                  </div>
                  <div class="ranking-info">
                    <h4>{{ municipality.name }}</h4>
                    <div class="ranking-stats">
                      <div class="ranking-stat">
                        <mat-icon>recycling</mat-icon>
                        <span>{{ municipality.collections | number }} collections</span>
                      </div>
                      <div class="ranking-stat">
                        <mat-icon>scale</mat-icon>
                        <span>{{ municipality.waste | number }} kg</span>
                      </div>
                      <div class="ranking-stat">
                        <mat-icon>people</mat-icon>
                        <span>{{ municipality.citizens | number }} citizens</span>
                      </div>
                    </div>
                  </div>
                  <div class="participation-badge">
                    <mat-icon>trending_up</mat-icon>
                    {{ municipality.participation }}%
                  </div>
                </div>
                }
              </div>
              }
              
              <!-- Municipality Admin: Top Collection Points -->
              @if (isMunicipalityAdmin()) {
              <div class="ranking-list">
                @for (cp of topCollectionPoints; track cp.name; let i = $index) {
                <div class="ranking-item">
                  <div class="rank-badge" [class.gold]="i === 0" [class.silver]="i === 1" [class.bronze]="i === 2">
                    {{ i + 1 }}
                  </div>
                  <div class="ranking-info">
                    <h4>{{ cp.name }}</h4>
                    <div class="ranking-stats">
                      <div class="ranking-stat">
                        <mat-icon>recycling</mat-icon>
                        <span>{{ cp.collections | number }} collections</span>
                      </div>
                      <div class="ranking-stat">
                        <mat-icon>scale</mat-icon>
                        <span>{{ cp.waste | number }} kg</span>
                      </div>
                      <div class="ranking-stat">
                        <mat-icon>place</mat-icon>
                        <span>{{ cp.location }}</span>
                      </div>
                      <div class="ranking-stat">
                        <mat-icon [style.color]="cp.status === 'ACTIVE' ? '#4CAF50' : '#f44336'">
                          {{ cp.status === 'ACTIVE' ? 'check_circle' : 'error' }}
                        </mat-icon>
                        <span>{{ cp.status }}</span>
                      </div>
                    </div>
                  </div>
                  <div class="participation-badge">
                    <mat-icon>trending_up</mat-icon>
                    {{ cp.participation }}%
                  </div>
                </div>
                }
              </div>
              }
            </div>
          </mat-tab>

          <!-- Material Distribution -->
          <mat-tab label="Material Distribution">
            <div class="tab-content">
              <div class="material-distribution">
                @for (material of materialDistribution; track material.type) {
                <div class="material-card">
                  <div class="material-header">
                    <mat-icon>{{ material.type === 'METAL' ? 'hardware' : (material.type === 'PLASTIC' ? 'water_drop' : (material.type === 'PAPER' ? 'description' : 'grade')) }}</mat-icon>
                    <h4>{{ material.type }}</h4>
                  </div>
                  <div class="material-stats">
                    <div class="percentage-display">
                      <span class="percentage-value">{{ material.percentage }}%</span>
                    </div>
                    <div class="material-weight">
                      <span class="weight-value">{{ material.weight | number }}</span>
                      <span class="weight-unit">kg</span>
                    </div>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="material.percentage"></div>
                  </div>
                </div>
                }
              </div>
            </div>
          </mat-tab>

          <!-- Regional Performance (System Admin) / Zone Performance (Municipality Admin) -->
          <mat-tab [label]="isSystemAdmin() ? 'Regional Performance' : 'Zone Performance'">
            <div class="tab-content">
              <div class="regional-grid">
                @for (region of regionalPerformance; track region.region) {
                <mat-card class="regional-card">
                  <mat-card-header>
                    <div mat-card-avatar class="regional-avatar">
                      <mat-icon>{{ isSystemAdmin() ? 'map' : 'location_on' }}</mat-icon>
                    </div>
                    <mat-card-title>{{ region.region }}</mat-card-title>
                    <mat-card-subtitle>
                      {{ region.municipalities }} {{ isSystemAdmin() ? 'municipalities' : 'collection points' }}
                    </mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="regional-stats">
                      <div class="regional-stat">
                        <mat-icon>recycling</mat-icon>
                        <div>
                          <span class="value">{{ region.collections | number }}</span>
                          <span class="label">Collections</span>
                        </div>
                      </div>
                      <div class="regional-stat">
                        <mat-icon>scale</mat-icon>
                        <div>
                          <span class="value">{{ region.waste | number }}</span>
                          <span class="label">Waste (kg)</span>
                        </div>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
                }
              </div>
            </div>
          </mat-tab>

          <!-- Collection Trends -->
          <mat-tab label="Collection Trends">
            <div class="tab-content">
              <div class="chart-container">
                <h3>Weekly Collection Trends</h3>
                <div class="bar-chart">
                  @for (trend of collectionTrends; track trend.day) {
                  <div class="bar-item">
                    <div class="bar-wrapper">
                      <div class="bar" [style.height.%]="(trend.collections / 700) * 100"></div>
                    </div>
                    <div class="bar-label">{{ trend.day }}</div>
                    <div class="bar-value">{{ trend.collections }}</div>
                  </div>
                  }
                </div>
              </div>
      </div>
          </mat-tab>
        </mat-tab-group>
      }

      <!-- Quick Actions -->
      <div class="quick-actions">
        <h3>Quick Actions</h3>
        <div class="actions-grid">
          @for (action of quickActions; track action.route) {
          <div 
            class="action-button"
            [routerLink]="action.route">
            <mat-icon>{{ action.icon }}</mat-icon>
            <span>{{ action.title }}</span>
          </div>
          }
        </div>
      </div>

      <!-- Recent Activity - Only for Citizens -->
      @if (isCitizen()) {
      <div class="recent-activity">
        <h3>Recent Activity</h3>
        
        <div class="activity-item">
          <div class="activity-icon">
            <mat-icon>recycling</mat-icon>
          </div>
          <div class="activity-content">
            <h4 class="activity-title">Metal waste collected</h4>
            <p class="activity-time">2 hours ago</p>
          </div>
        </div>
        
        <div class="activity-item">
          <div class="activity-icon">
            <mat-icon>card_giftcard</mat-icon>
          </div>
          <div class="activity-content">
            <h4 class="activity-title">Reward redeemed</h4>
            <p class="activity-time">1 day ago</p>
          </div>
        </div>
        
        <div class="activity-item">
          <div class="activity-icon">
            <mat-icon>eco</mat-icon>
          </div>
          <div class="activity-content">
            <h4 class="activity-title">Environmental impact achieved</h4>
            <p class="activity-time">3 days ago</p>
          </div>
        </div>
      </div>
      }
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>